trigger:
- main
- fix/ci-e2e

variables:
  buildConfiguration: 'Release'
  artifactName: 'drop'

stages:
- stage: CI_BuildAndTest
  displayName: '1. Build, Pruebas y Empaquetado'
  jobs:
  - job: Build
    pool:
      vmImage: 'windows-latest'
    steps:
      # Restore
      - task: DotNetCoreCLI@2
        displayName: 'dotnet restore'
        inputs:
          command: 'restore'
          projects: '**/*.sln'

      # Renombrar archivo de configuración si no existe
      - powershell: |
          Write-Host "Verificando archivo de configuración..."
          $configPath = "BlazorServer\appsettings.json"
          $examplePath = "BlazorServer\appsetting_sExample.json"
  
          if (Test-Path $examplePath) {
              Write-Host "Encontrado: $examplePath"
                
              if (-not (Test-Path $configPath)) {
                  Write-Host "Renombrando appsetting_sExample.json a appsettings.json"
                  Rename-Item -Path $examplePath -NewName "appsettings.json"
              } else {
                  Write-Host "appsettings.json ya existe, no se renombra"
              }
  
            } else {
                Write-Host "No se encontró $examplePath, se omite el renombrado"
          }
        displayName: 'Renombrar appsettings.json si es necesario'

      # Unit & Component tests
      - task: DotNetCoreCLI@2
        displayName: 'dotnet test (Unitarias y Componentes)'
        inputs:
          command: 'test'
          projects: '**/BlazorServer.Tests/*.csproj'
          arguments: '--configuration $(buildConfiguration)'

      # Build E2E project
      - task: DotNetCoreCLI@2
        displayName: 'dotnet build (E2E)'
        inputs:
          command: 'build'
          projects: '**/BlazorServer.E2E/*.csproj'
          arguments: '--configuration $(buildConfiguration)'

      - task: PowerShell@2
        displayName: 'Generar .buildinfo.json con build real'
        inputs:
          targetType: 'inline'
          script: |
            # Variables de Azure DevOps
            $BuildNumber = "$(Build.BuildNumber)"  # primera línea: build real
            $BuildId = "$(Build.BuildId)"          # segunda línea: build id real

            # Ruta del archivo .buildinfo.json al lado del appsettings.json
            $FilePath = "BlazorServer\.buildinfo.json"

            Write-Host "Generando .buildinfo.json en: $FilePath"
            Write-Host "BuildNumber: $BuildNumber"
            Write-Host "BuildId: $BuildId"

            # Línea 1 → BuildNumber real
            # Línea 2 → BuildId real
            $BuildNumber | Out-File $FilePath -Encoding UTF8
            $BuildId | Out-File $FilePath -Append -Encoding UTF8

            Write-Host ".buildinfo.json generado correctamente con build real."

      # Install Playwright browser binaries
      - task: CmdLine@2
        displayName: 'Playwright: Install Browser Binaries'
        inputs:
          script: 'dotnet tool install --global Microsoft.Playwright.CLI && playwright install'

    # Arranca la aplicación en segundo plano para que las pruebas E2E puedan acceder a localhost:5000.
      - task: CmdLine@2
        displayName: 'Start Blazor Server (Background)'
        inputs:
          script: 'start /B dotnet run --project BlazorServer/BlazorServer.csproj --urls "http://localhost:5000"'


      # Wait for server availability
      - powershell: |
          $url = "http://localhost:5000"
          $maxAttempts = 20
          $delay = 5
          $requiredSuccesses = 3
          $successCount = 0

          Write-Host "Esperando que el servidor responda $requiredSuccesses veces consecutivas en $url..."

          for ($i = 1; $i -le $maxAttempts; $i++) {
              try {
                  $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 3
                  if ($response.StatusCode -eq 200) {
                      $successCount++
                      Write-Host "Intento $($i): OK ($($successCount)/$($requiredSuccesses) consecutivas)"
                      if ($successCount -ge $requiredSuccesses) {
                          Write-Host "Servidor disponible correctamente."
                          break
                      }
                  } else {
                      $successCount = 0
                      Write-Host "Intento $($i): Status $($response.StatusCode), reiniciando conteo de consecutivas."
                  }
              } catch {
                  $successCount = 0
                  Write-Host "Intento $($i): servidor no disponible, reiniciando conteo de consecutivas."
              }
              Start-Sleep -Seconds $delay
          }

          if ($successCount -lt $requiredSuccesses) {
              Write-Host "ERROR: El servidor no respondió 3 veces consecutivas en $maxAttempts intentos."
              exit 1
          }
        displayName: 'Esperar servidor: 20 intentos, 5s entre cada uno, 3 respuestas consecutivas'


      # E2E Tests (Playwright)
      - task: DotNetCoreCLI@2
        displayName: 'dotnet test (Pruebas E2E Playwright)'
        inputs:
          command: 'test'
          projects: '**/BlazorServer.E2E/*.csproj'
          arguments: '--configuration $(buildConfiguration)'

      # Publish application
      - task: DotNetCoreCLI@2
        displayName: 'dotnet publish'
        inputs:
          command: 'publish'
          publishWebProjects: true
          projects: 'BlazorServer/BlazorServer.csproj'
          arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'

      # Publish artifacts
      - task: PublishBuildArtifacts@1
        displayName: 'Publicar Artefactos (drop)'
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: '$(artifactName)'